【2020年5月1日】整理自[【微擎开发文档】](http://s.w7.cc/index.php?c=wiki&do=view&id=1&list=13)


# 微擎

## 入门介绍

微擎是基于目前最流行的 `WEB 2.0` 的架构（php+mysql），运行环境我们推荐使用：

* linux(centOS)
* nginx
* php 5.3
* mysql 5.6

> 更多了解可跳转自[【入门指引】](http://s.w7.cc/index.php?c=wiki&do=view&id=1&list=19)

### 环境安装

服务器环境要求：

* IIS / Apache / Nginx
* PHP >= 5.6
* MySQL >= 5

> 更多了解可跳转自[【环境安装】](http://s.w7.cc/index.php?c=wiki&do=view&id=1&list=26)

## 框架使用

### 入口脚本

入口脚本是应用启动流程中的第一环，入口文件根据 **`系统配置文件`** 初始化了系统的常量、全局变量及全局对象，并将终端用户的请求通过入口脚本将请求转发到各自的功能模块中

微擎系统中分为三个入口，分别是：

* Web 端入口
* App 端入口
* 微信 Api 入口

### 系统配置文件

系统配置文件存放着微擎系统重要的启动数据，文件是 `/data/config.php`

> 此文件禁止普通用户修改

### Web 端入口

Web 端入口主要负责微擎系统的后台管理功能

* 入口文件是 `/web/index.php`

* 访问此入口有严格的权限判断，需要用户进行登录

* 此入口主要完成以下工作：

  * 登录用户的身份验证
  * 初始化登录用户的身份信息，分派管理员权限或是操作员权限
  * 权限菜单划分及权限判断
  * 加载系统配置
  * 路由用户的请求

### App 端入口

App 端入口主要负责微擎系统的前端 **`微站`** 、**`个人中心`** 及其它普通用户访问的功能

* 入口文件是 `/app/index.php`

* 访问 **`微站`** 无需身份验证

  访问 **`个人中心`** 则要求用户进行登录

* 此入口主要完成以下工作：

  * 初始化当前公众号的数据
  * 初始化微站站点信息、风格、模板、导航等数据
  * 初始化粉丝&会员的身份信息（如果有权限获取）
  * 加载系统配置
  * 路由用户的请求

### 微信 Api 入口

微信 Api 入口主要负责处理微信公众平台请求微擎系统的关键字、图片、语音等数据

* 入口文件是 `api.php`

* 此入口只用于公众平台访问

* 此入口主要完成以下工作：

  * 初始化当前公众号的数据
  * 解析公众平台推送过来的数据结构，转化为微擎消息结构
  * 根据消息结构中的关键字或是事件匹配到相应的模块
  * 调用模块的 processor 类返回数据给微信公共平台

## 目录结构

```
we7
├─ addons                                   模块安装目录(意为附加组件)
│  ├─ business                              模块的名称(示例)
│  │  ├─ images                             建议 css 文件也放此目录.
│  │  ├─ template                           模板目录
│  │  │  ├─ mobile                          APP 端模板目录
│  │  │  │  └─ ... *.html                   APP 端模板文件
│  │  │  └─ ... *.html                      Web 端模板文件
│  │  ├─ inc                                引用的 php 文件目录
│  │  │  ├─ mobile                          Mobile端目录
│  │  │  │  ├─ xxx.inc.php                  微站入口
│  │  │  │  └─ ...                          .
│  │  │  └─ web                             Web端模板目录
│  │  │      ├─ xxx.inc.php                 微站管理入口
│  │  │      └─ ...                         .
│  │  ├─ icon.jpg                           模块图标
│  │  ├─ preview.jpg                        模块预览
│  │  ├─ manifest.xm<x>l                       安装清单
│  │  ├─ module.php                         模块设置
│  │  ├─ processor.php                      消息处理
│  │  ├─ receiver.php                       消息订阅
│  │  ├─ webapp.php                         PC版页面功能
│  │  ├─ wxapp.php                          小程序接口功能
│  │  ├─ hook.php                           嵌入点
│  │  └─ site.php                           微站页面
│  └─ ...                                   其他扩展模块
├─ api                                      .
│  └─ accesstoken.php                        多系统共用accesstoken接口
│  └─ uc.php                                .
├─ attachment                               附件文件夹
│  ├─ audios                                音频附件文件夹
│  └─ images                                图片附件文件夹
│      ├─ global                            系统公共文件夹
│      │  └─ 上传年份
│      │        └─上传月份
│      │             └─ 随机文件名
│      └─ $uniacid ...                      按公众号年月组织的图片文件
├─ app                                      微站(Mobile)入口
│  ├─ common                                .
│  │  ├─ bootstrap.app.inc.php              .
│  │  ├─ common.func.php                    .
│  │  └─ template.func.php                  .
│  ├─ resource                              .
│  │  ├─ css                                .
│  │  ├─ fonts                              .
│  │  └─ js                                 .
│  ├─ source                                控制器
│  ├─ themes                                微站皮肤
│  │  ├─ default                            系统默认
│  │  └─ ...                                自定义皮肤
│  └─ index.php                             微站入口
├─ data                                     .
│  ├─ config.php                            系统配置
│  └─ db.php                                .
├─ framework                                微擎系统通用的工具类和方法
│  ├─ builtin                               微擎内建模块
│  │  ├─ basic                              文字回复模块
│  │  ├─ core                               会话消息统计
│  │  │  └─ receiver.php                    .
│  │  ├─ cover                              通用封面回复
│  │  ├─ default                            默认回复模块
│  │  ├─ music                              音乐回复模块
│  │  ├─ news                               图文回复模块
│  │  ├─ userapi                            自定义接口回复模块
│  │  └─ ...                                .
│  ├─ class                                 系统功能类
│  ├─ function                              系统功能函数
│  ├─ library                               其他函数库
│  ├─ model                                 业务功能model
│  ├─ table                                 数据库表model
│  ├─ bootstrap.inc.php                     .
│  ├─ const.inc.php                         .
│  └─ version.inc.php                       .
├─ payment                                  支付
├─ web                                      后台管理(Web)入口
│  ├─ common                                公用文件
│  │  ├─ bootstrap.sys.inc.php              .
│  │  ├─ common.func.php                    .
│  │  ├─ frames.inc.php                     .
│  │  └─ template.func.php                  .
│  ├─ resource                              资源文件
│  │  ├─ components                         JS组件
│  │  ├─ css                                样式文件
│  │  ├─ fonts                              字体资源
│  │  ├─ images                             图片文件
│  │  └─ js                                 .
│  │      ├─ app                            系统js功能
│  │      ├─ lib                            js第三方库文件
│  │      └─ require.js                     .
│  ├─ source                                后台管理控制器
│  ├─ themes                                后台管理视图
│  │  ├─ default                            内建后台管理样式
│  │  └─ ...                                定制界面样式
│  └─ index.php                             后台入口
├─ api.php                                  公众平台与微擎系统通信的接口
├─ index.php                                微擎入口
└─ install.php                              微擎安装程序
```

### 结构图

![图片](http://cdn.w7.cc/images/2017/12/28/15144252165a444b808426a_bFbFFzc20BfL.png)

> 图片未正常显示时可[【点击查看】](http://cdn.w7.cc/images/2017/12/28/15144252165a444b808426a_bFbFFzc20BfL.png)

## 数据库字典

> 因数据较多，更多细节点击[【数据库字典】](http://s.w7.cc/index.php?c=wiki&do=view&id=1&list=133)查看

## 配置选项

* 配置文件路径：`/data/config.php`

* 修改方法：修改对应数组的参数即可生效

* 对应配置项：

  * `$config[db]` 数据库配置
  * `$config[cookie]` 系统 COOKIE 配置项
  * `$config[setting]` 系统设置
  * `$config[upload]` 上传配置(已废弃，统一在系统附件设置中更改)

> 更多细节点击[【配置选项】](http://s.w7.cc/index.php?c=wiki&do=view&id=1&list=134)查看

## 预定义常量

> 因数据较多，更多细节点击[【预定义常量】](http://s.w7.cc/index.php?c=wiki&do=view&id=1&list=14)查看

## 全局变量

* $_GPC

  全局请求变量, 获取 `$_GET` ，`$_POST` ，`$_COOKIES` 中的变量

* $_W

  `$_W`（大写 `W` ），是系统中最为重要的全局变量，微擎系统中很多常用的数据都存储在这个变量之中，下面我们详细讲解一下此变量的结构

  * 全局配置
  * 系统配置
  * 公众号相关
  * Web 端可见
  * App 端可见
  * 网页授权

> 更多细节点击[【全局变量】](http://s.w7.cc/index.php?c=wiki&do=view&id=1&list=18)查看

## URL 路由

入口脚本程序获取到到 URL 中相关的 GET 参数，解析后进行权限判断，然后调用相应的控制器处理这个请求

* 该过程就被称为 URL 路由（routing）

约定及使用 GET 参数中的 `c` 、`a` 、`do` 为微擎系统的路由参数

* 应当避免与系统参数冲突

* 在程序中可以使用 `$controller` 、`$action` 、`$do` 来获取对应的路由三个参数

### 地址 URL 地址路由

当传入的 URL 请求中包含一个名为 `c` 、`a` 、`do` (可选)的 GET 参数，它即被视为一个路由，例如：

* 以下 URL 会路由至 `/web/source/platform/menu.ctrl.php` 文件中

```
http://we7.cc/web/index.php?c=platform&a=menu&
```

* 以下 URL 则会路由至 `/app/source/mc/home.ctrl.php` 文件中

```
http://we7.cc/app/index.php?c=mc&a=home&
```

### 模块 URL 地址路由

#### web 端

当传入的 c 值为 `site` , a 值为 `entry` 时则是一个模块路由

* 例如，以下 URL 会路由至 `/addons/we7_demo/site.php` 文件中的 `doWebThemeset()` 方法

```
http://we7.cc/web/index.php?c=site&a=entry&do=themeset&m=we7_demo
```

#### app 端

当传入的 c 值为 `entry` 时则是一个模块路由

* 如果 a 值为空，默认进入模块的 `site.php`

* 如果 a 值不为空，则进入对应的模块 php 文件

  a 的有效值有：

  * aliapp
  * baiduapp
  * phoneapp
  * site
  * toutiaoapp
  * webapp
  * wxapp
  * xzapp

例如，以下 URL 会：

* 路由至 `/addons/we7_demo/site.php` 文件中的 `doMobileList()` 方法

```
http://we7.cc/app/index.php?i=1&j=2&c=entry&do=list&m=we7_demo
```

* 路由至 `/addons/we7_demo/wxapp.php` 文件中的 `doPageList()` 方法

```
http://we7.cc/app/index.php?i=1&j=2&c=entry&a=wxapp&do=list&m=we7_demo
```

### url() 创建一个 URL

语法：`url($segment, $params = array(), $noredirect = false)`

* 路由的表达式以斜杠 `/` 的方式组织，每个以斜杠分隔的片段都是指向某一控制器（controller）、操作（action）或是行为（do）

* 第二个参数则是以数组的形式表示 URL 中的 QueryString

```
echo url('site/entry/themeset', array('m' => 'we7_demo'));
// http://we7.cc/web/index.php?c=site&a=entry&do=themeset&m=we7_demo
echo url('mc/home');
// http://we7.cc/app/index.php?c=mc&a=home&
```

### createMobileUrl()

`$this->createMobileUrl()`

* 模块中二次封装了系统的 `url()` 函数，使用时变的更加简单

* 语法：`$this->createMobileUrl(string $string)`

* 作用：生成 app 端的 url

```
class We7_demoModuleSite extends WeModuleSite {
    public function doMobileIndex() {
        echo $this->createMobileUrl('home');
    }
    public function doMobileHome() {
        // 上面 doMobileIndex() 生成的链接会进入到这里
    }
}
```

### createWebUrl()

`$this->createWebUrl()`

* 模块中二次封装了系统的 `url()` 函数，使用时变的更加简单

* 语法：`$this->createWebUrl(string $string)`

* 作用：生成 web 端 url

```
class We7_demoModuleSite extends WeModuleSite {
    public function doWebIndex() {
        echo $this->createWebUrl('home');
    }
    public function doWebHome() {
        // 上面 doWebIndex() 生成的链接会进入到这里
    }
}
```

## 文件加载器

微擎系统依靠 Load 类进行类、函数、模型的加载，该类会在系统初始化时引用并且实例化，系统提供 `load()` 函数来引用该类的实例

> 注：使用 `load()` 加载文件时，可以重复加载

### func()

`load()->func()`

* 加载系统公共函数

* 语法：`load()->func(string $string)`

* 作用：加载文件为 `framework/function/*.func.php`

```
// framework/function/logging.func.php
load()->func('logging');
```

### class()

`load()->class()`

* 加载系统公共类

* 语法：`load()->classs(string $string)`

* 作用：加载文件为 `framework/class/*.class.php`

```
// framework/class/account.class.php
load()->classs('account');
```

### model()

`load()->model()`

* 加载系统 model 函数

* 语法：`load()->model(string $string)`

* 作用：加载文件为 `framework/model/*.mod.php`

```
/ framework/model/attachment.mod.php
load()->model('attachment');
```

### web()

`load()->web()`

* 加载 web 端公共函数

* 语法：`load()->web(string $string)`

* 作用：加载文件为 `web/common/*.php`

```
// web/common/tpl.func.php
load()->web('tpl');
```

### app()

`load()->app()`

* 加载 app 端公共函数

* 语法：`load()->app(string $string)`

* 作用：加载文件为 `app/common/*.php`

```
// app/common/tpl.func.php
load()->app('tpl');
```

### library()

`load()->library()`

* 加载一个库文件

* 语法：`load()->library(string $string)`

* 作用：加载文件为 `framework/library` 下的文件

#### 别名

```
$libraryMap = array(
    'agent' => 'agent/agent.class',
    'captcha' => 'captcha/captcha.class',
    'pdo' => 'pdo/PDO.class',
    'qrcode' => 'qrcode/phpqrcode',
    'ftp' => 'ftp/ftp',
    'pinyin' => 'pinyin/pinyin',
    'pkcs7' => 'pkcs7/pkcs7Encoder',
    'json' => 'json/JSON',
    'phpmailer' => 'phpmailer/PHPMailerAutoload',
    'oss' => 'alioss/autoload',
    'qiniu' => 'qiniu/autoload',
    'cos' => 'cosv4.2/include',
    'cosv3' => 'cos/include',
);
```

* 当定义别名时，可以直接使用

```
load()->library('agent');
// 将引用 framework/library/agent/agent.class.php
```

* 未定义别名时，需要指定要引用的文件，不写扩展名

```
load()->library('agent/agent.class');
// 将引用 framework/library/agent/agent.class.php
```

### object()

`load()->object()`

* 语法：`load()->object(string $string)`

* 作用：将 `framework/class` 目录下的类文件，实例化后返回

```
$cloudapi = load()->object('cloudapi');
```

### singleton()

`load()->singleton()`

* 语法：`load()->singleton(string $string)`

* 作用：将 `framework/class` 目录下的类文件，实例化成单例返回

```
$cloudapi = load()->singleton('cloudapi');
```

## 缓存机制

数据缓存是指将一些 PHP 变量存储到缓存中，使用时再从缓存中取回，避免过多的操作直接从数据库中存取，减轻数据库压力

* 微擎系统提供一系列的操作缓存的函数，不需要开发者手动加载引入

### 缓存规范

#### 缓存书写规范

在微擎系统中，缓存大致可以分为两种：

* 全局性的缓存，一次建立所有用户皆可以使用的缓存

  比如：菜单数据、站点配置信息等等

* 特有的缓存，缓存只针对于某个用户有效

  比如：粉丝数据、会员数据等等

> 对于重建缓存操作中需要有数据的拼接、计算、获取的复杂操作，建议将重建缓存函数单独封装成一个方法
>> 在微擎系统中是存放在 `cache.mod.php` 中，否则您只需要在模型函数中处理即可

#### 缓存命名空间

* 对于缓存数据来说，强烈建议您存放时增加自己有前缀以防止数据冲突

* 命名键名时应该使键名以功能分组，以冒号隔开

  例如公众号相关的缓存命名为：`account:info` ，`account:auth` 等等

* 系统的缓存数据是以 `we7:` 开头，使用时用 `cache_system_key('account:info')` 即可

### 缓存执行流程

[【点击查看流程图详情】](http://s.w7.cc/index.php?c=wiki&do=view&id=1&list=171)

### cache_write()

按照指定的键名存储缓存数据

* 语法：`cache_write(string $key, mixed $data)`

* 参数

  `$key` 参数指定要存储缓存数据的键名，键名必须保证是唯一

  `$data` 参数指定要存储数据的内容，可以为字符串，数组等

```
$data = array(1, 2, 3);
cache_write('test', $data);
cache_write('test1', 'testdata');
```

### cache_load()

读取指定键名的缓存数据

* 语法：`cache_load(string $key)`

* 参数：

  `$key` 参数指定要读取缓存数据的键名

```
$data = array(1, 2, 3);

cache_write('test', $data);
$result = cache_load('test');

cache_write('test1', 'testdata');
cache_load('test1'); //未接收返回值时，缓存数据会保存在 $_W['cache'] 中
```

### cache_delete()

删除指定的缓存

* 语法：`cache_delete(string $key)`

* 参数：

  `$key` 参数指定要删除缓存数据的键名

```
$data = array(1, 2, 3);

cache_write('test', $data);
cache_delete('test');
```

### cache_clean()

清空所有缓存

* 语法：`cache_clean(void)`

```
cache_clean();
```

### cache_system_key()

统一系统缓存名称前缀，支持缓存名称中包含占位符，最多不得超过5个

* 语法：`cache_system_key($cache_key)`

```
$cachekey = cache_system_key('permission:%s:%s', $_W['uniacid'], $_W['uid']);
$cache = cache_load($cachekey);
```

> 也可以将 `'permission:%s:%s'` 定义为常量，方便统一管理

## 数据库

微擎系统数据库操作使用 PDO 兼容方式，以参数绑定的形式进行查询操作

* 系统已对 PDO 兼容性进行检测及封装

### 指定表前缀 `tablename()`

为了防止微擎系统的表与其它系统命名冲突，安装微擎时均会指定一个表前缀

* 在写 SQL 语句时，需要将表名称附加上表前缀

* 可以使用 `tablename()` 函数

```
$sql = "SELECT * FROM ".tablename('users');
echo $sql;
// 输出 SELECT * FROM ims_users
```

### 范围条件操作

在 `微擎20160601` 以后的版本中，增加了以下范围条件的支持：

* pdo_get
* pdo_getall
* pdo_getcolumn
* pdo_getslice
* pdo_insert
* pdo_update
* pdo_delete

具体支持的范围操作符：`$allow_operator = array('>', '<', '<>', '!=', '>=', '<=', '+=', '-=', 'LIKE', 'like')`

```
// 获取 acid 大于 269 的公众号
$account = pdo_get('account', array('acid >' => '269'));

// 增加一次用户的错误登录次数，两次变为 2 即可
pdo_update('users_failed_login', array('count +=' => 1), array('username' => 'mizhou'));
```

### `IN` 和 `NOT IN`

当传入的条件数组的值为数组时，系统会自动转成成 `IN` 语句，如果和 `<>` 或 `!=` （不等于）一起使用时，会自动转换为 `NOT IN`

```
pdo_getall('users', array('uid' => array('1', '2', '3')));

// 对应的 SQL 语句调用
pdo_fetchall("SELECT * FROM `ims_users` WHERE `uid` IN (:__uid_0,:__uid_1,:__uid_2)", array(':__uid_0' => 1, ':__uid_1' => 2, ':__uid_2' => 3));
```

```
pdo_getall('users', array('uid <>' => array('1', '2', '3')));

// 对应的 SQL 语句调用
pdo_fetchall("SELECT * FROM `ims_users` WHERE `uid` NOT IN (:__uid_0,:__uid_1,:__uid_2)", array(':__uid_0' => 1, ':__uid_1' => 2, ':__uid_2' => 3));
```

### `IS NULL` 和 `IS NOT NULL`

当且仅当值为大写的 NULL 字符串时，系统会认为这是需要查询 NULL 值，会将 SQL 写成 `IS NULL` 的形式，具体如下：

```
pdo_get('users', array('username' => 'NULL'));

// 此语句会转化为
SELECT * FROM user WHERE username IS NULL
```

### 聚合查询

当获取的字段中是聚合字段时，比如 `COUNT(*)` , `SUM()` 等

* 如果指定过别名，则可以真通过别名获取值

* 如果未指定别名，则可以通过字段排序的索引获取

```
$usercount = pdo_get('users', array(), array('COUNT(*)', 'uid', 'MAX(uid)', 'MIN(uid) AS minuid'));

// $usercount 值为
Array (
    [0] => 103 // 总数
    [uid] => 1
    [2] => 179 // 最大 UID
    [minuid] => 1 // 最小 UID
)
```

### 链示查询

自微擎 `v1.5.7` 版本以后，增加链式查询类，提供面向对象方式查询数据，链式查询只支持一些常用简单的查询过于复杂的业务需求还是建议直接使用 SQL 语句

查询用户表中的前十条男性的用户数据，代码如下：

```
$query = load()->ob<x>ject('query');
$row = $query->from('users')->where('type', '1')->orderby('uid', 'desc')->limit(10)->getall();
```

### SQL 注入安全

#### SQL 参数绑定

参数绑定就是绑定一个 PHP 变量到用作预处理的 SQL 语句中的对应命名占位符或问号占位符

* 可以有效的防止 SQL 注入

> 注：要求无论何时尽量使用参数绑定的形式来构建 SQL 语句


























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































